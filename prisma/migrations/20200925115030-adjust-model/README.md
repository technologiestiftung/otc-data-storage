# Migration `20200925115030-adjust-model`

This migration has been generated by fabianmoronzirfas at 9/25/2020, 1:50:31 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
ALTER TABLE "public"."CountDetection" DROP CONSTRAINT "CountDetection_counterId_fkey"

ALTER TABLE "public"."CountDetection" DROP CONSTRAINT "CountDetection_detectionTypeId_fkey"

ALTER TABLE "public"."CountDetection" DROP CONSTRAINT "CountDetection_trajectoryId_fkey"

ALTER TABLE "public"."Counter" DROP CONSTRAINT "Counter_cameraId_fkey"

ALTER TABLE "public"."Counter" DROP COLUMN "cameraId",
ADD COLUMN "recordingId" integer   ,
ADD COLUMN "detectionTypeId" integer

CREATE TABLE "public"."Recording" (
"id" SERIAL,
"createdAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"recordingStart" timestamp(3)   NOT NULL ,
"recordingEnd" timestamp(3)   NOT NULL ,
"cameraId" integer   ,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."Detection" (
"id" SERIAL,
"createdAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"detectedAt" timestamp(3)   NOT NULL ,
"counterId" integer   NOT NULL ,
"detectionTypeId" integer   NOT NULL ,
"confidence" integer   NOT NULL ,
"trajectoryId" integer   ,
PRIMARY KEY ("id")
)

ALTER TABLE "public"."Recording" ADD FOREIGN KEY ("cameraId")REFERENCES "public"."Camera"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "public"."Detection" ADD FOREIGN KEY ("counterId")REFERENCES "public"."Counter"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."Detection" ADD FOREIGN KEY ("detectionTypeId")REFERENCES "public"."DetectionType"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."Detection" ADD FOREIGN KEY ("trajectoryId")REFERENCES "public"."Trajectory"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "public"."Counter" ADD FOREIGN KEY ("recordingId")REFERENCES "public"."Recording"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "public"."Counter" ADD FOREIGN KEY ("detectionTypeId")REFERENCES "public"."DetectionType"("id") ON DELETE SET NULL ON UPDATE CASCADE

DROP TABLE "public"."CountDetection"
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20200921130401-renaming-and-cleaning..20200925115030-adjust-model
--- datamodel.dml
+++ datamodel.dml
@@ -2,14 +2,14 @@
 // learn more about it in the docs: https://pris.ly/d/prisma-schema
 // datasource db {
 //   provider = "sqlite"
-//   url = "***"
+//   url = "***"
 // }
 datasource db {
   provider = "postgresql"
-  url = "***"
+  url = "***"
 }
 generator client {
   provider = "prisma-client-js"
@@ -36,20 +36,34 @@
   // polygon
   geom                 String?
   // Geometry(Line, 4326)
   angle                String?
-  counters             Counter[]
+  recordings           Recording[]
   trajectories         Trajectory[]
   weathers             Weather[]
   lightningConditions  LightningCondition[]
+  // Counter              Counter[]
 }
+model Recording {
+  id             Int       @default(autoincrement()) @id
+  createdAt      DateTime  @default(now())
+  recordingStart DateTime
+  recordingEnd   DateTime
+  counters       Counter[]
+  Camera         Camera?   @relation(fields: [cameraId], references: [id])
+  cameraId       Int?
+}
+
+// Counter should be equivalent to Counter
+// https://opendatacam.github.io/opendatacam/apidoc/#api-Counter
+// curl "http://192.168.1.210:8080/counter/areas"
 model Counter {
   id        Int      @default(autoincrement()) @id
   createdAt DateTime @default(now())
   // active    Boolean
-  camera    Camera   @relation(fields: [cameraId], references: [id])
-  cameraId  Int
+  // camera    Camera   @relation(fields: [cameraId], references: [id])
+  // cameraId  Int
   // manually
   street    String
   // manually
   streetId  String // or Int?
@@ -60,21 +74,27 @@
   // Geometry(Line, 4326)
   // createa manually by try and error :D
+  // if we have a geom on the camera
+  // we can calculate that line string from the coordinates
   line            String
   // should be actually
   // - bidirectional
   // - left
   // - right
   direction       String
-  countDetections CountDetection[]
+  detections      Detection[]
+  Recording       Recording?     @relation(fields: [recordingId], references: [id])
+  recordingId     Int?
+  DetectionType   DetectionType? @relation(fields: [detectionTypeId], references: [id])
+  detectionTypeId Int?
 }
 // is there also a detection object which holds all the objects
 // of every frame detected?
 // https://opendatacam.github.io/opendatacam/apidoc/#api-Recording-Counter_data
-model CountDetection {
+model Detection {
   id              Int           @default(autoincrement()) @id
   createdAt       DateTime      @default(now())
   detectedAt      DateTime
   counter         Counter       @relation(fields: [counterId], references: [id])
@@ -89,13 +109,14 @@
   trajectoryId    Int?
 }
 model DetectionType {
-  id              Int              @default(autoincrement()) @id
-  label           String
-  description     String?
-  countDetections CountDetection[]
-  trajectories    Trajectory[]
+  id           Int          @default(autoincrement()) @id
+  label        String
+  description  String?
+  counters     Counter[]
+  trajectories Trajectory[]
+  detections   Detection[]
 }
 // is a collection of detections
 // replace by the track object
@@ -109,13 +130,13 @@
   trajectory String
   // Geometry(LineStringM, 4326)
   geom            String
-  detectionType   DetectionType    @relation(fields: [detectionTypeId], references: [id])
+  detectionType   DetectionType @relation(fields: [detectionTypeId], references: [id])
   detectionTypeId Int
   start           DateTime
   end             DateTime
-  countDetections CountDetection[]
+  detections      Detection[]
 }
 model Weather {
```
