# Migration `20200921130401-renaming-and-cleaning`

This migration has been generated by fabianmoronzirfas at 9/21/2020, 3:04:01 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
ALTER TABLE "public"."Detection" DROP CONSTRAINT "Detection_counterId_fkey"

ALTER TABLE "public"."Detection" DROP CONSTRAINT "Detection_detectionTypeId_fkey"

ALTER TABLE "public"."Counter" DROP COLUMN "active"

CREATE TABLE "public"."CountDetection" (
"id" SERIAL,
"createdAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"detectedAt" timestamp(3)   NOT NULL ,
"counterId" integer   NOT NULL ,
"detectionTypeId" integer   NOT NULL ,
"confidence" integer   NOT NULL ,
"trajectoryId" integer   ,
PRIMARY KEY ("id")
)

ALTER TABLE "public"."CountDetection" ADD FOREIGN KEY ("counterId")REFERENCES "public"."Counter"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."CountDetection" ADD FOREIGN KEY ("detectionTypeId")REFERENCES "public"."DetectionType"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."CountDetection" ADD FOREIGN KEY ("trajectoryId")REFERENCES "public"."Trajectory"("id") ON DELETE SET NULL ON UPDATE CASCADE

DROP TABLE "public"."Detection"
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20200917145022-init..20200921130401-renaming-and-cleaning
--- datamodel.dml
+++ datamodel.dml
@@ -2,23 +2,23 @@
 // learn more about it in the docs: https://pris.ly/d/prisma-schema
 // datasource db {
 //   provider = "sqlite"
-//   url = "***"
+//   url = "***"
 // }
 datasource db {
   provider = "postgresql"
-  url = "***"
+  url = "***"
 }
 generator client {
   provider = "prisma-client-js"
 }
-generator dbml {
-  provider = "prisma-dbml-generator"
-}
+// generator dbml {
+//   provider = "prisma-dbml-generator"
+// }
 model Camera {
   id                   Int                  @default(autoincrement()) @id
   createdAt            DateTime             @default(now())
@@ -31,8 +31,10 @@
   software             String?
   softwareHistory      String?
   hardware             String?
   // Geometry(Point, 4326)
+  // try and error view of the camera as geo object
+  // polygon
   geom                 String?
   // Geometry(Line, 4326)
   angle                String?
   counters             Counter[]
@@ -43,47 +45,63 @@
 model Counter {
   id        Int      @default(autoincrement()) @id
   createdAt DateTime @default(now())
-  active    Boolean
+  // active    Boolean
   camera    Camera   @relation(fields: [cameraId], references: [id])
   cameraId  Int
+  // manually
   street    String
+  // manually
   streetId  String // or Int?
   x1        Float
   y1        Float
   x2        Float
   y2        Float
   // Geometry(Line, 4326)
-  line       String
-  // Geometry(Line, 4326)
-  direction  String
-  detections Detection[]
+  // createa manually by try and error :D
+  line            String
+  // should be actually
+  // - bidirectional
+  // - left
+  // - right
+  direction       String
+  countDetections CountDetection[]
 }
-model Detection {
+// is there also a detection object which holds all the objects
+// of every frame detected?
+// https://opendatacam.github.io/opendatacam/apidoc/#api-Recording-Counter_data
+model CountDetection {
   id              Int           @default(autoincrement()) @id
   createdAt       DateTime      @default(now())
   detectedAt      DateTime
   counter         Counter       @relation(fields: [counterId], references: [id])
   counterId       Int
   detectionType   DetectionType @relation(fields: [detectionTypeId], references: [id])
   detectionTypeId Int
-  accuracy        Float
-  x               Float
-  y               Float
+  confidence      Int
+  // x               Float
+  // y               Float
+  // could have a relation to the trajectories
+  Trajectory      Trajectory?   @relation(fields: [trajectoryId], references: [id])
+  trajectoryId    Int?
 }
 model DetectionType {
-  id           Int          @default(autoincrement()) @id
-  label        String
-  description  String?
-  detections   Detection[]
-  trajectories Trajectory[]
+  id              Int              @default(autoincrement()) @id
+  label           String
+  description     String?
+  countDetections CountDetection[]
+  trajectories    Trajectory[]
 }
+// is a collection of detections
+// replace by the track object
+// https://opendatacam.github.io/opendatacam/apidoc/#api-Recording-Tracker_data
+//
 model Trajectory {
   id         Int    @default(autoincrement()) @id
   camera     Camera @relation(fields: [cameraId], references: [id])
   cameraId   Int
@@ -91,12 +109,14 @@
   trajectory String
   // Geometry(LineStringM, 4326)
   geom            String
-  detectionType   DetectionType @relation(fields: [detectionTypeId], references: [id])
+  detectionType   DetectionType    @relation(fields: [detectionTypeId], references: [id])
   detectionTypeId Int
   start           DateTime
   end             DateTime
+  countDetections CountDetection[]
+
 }
 model Weather {
   id            Int      @default(autoincrement()) @id
@@ -112,8 +132,10 @@
   wind          Float?
   windDirection Float?
 }
+// could also be some sensordata taken from the
+// enviro plus
 model LightningCondition {
   id         Int      @default(autoincrement()) @id
   camera     Camera   @relation(fields: [cameraId], references: [id])
   cameraId   Int
```


